import * as _ from 'lamb'
import { stringify } from '@svizzle/utils';
import { buildRequest, makeRequest } from 'es/requests.mjs';

/**
 * @function update
 * @description update a document on an ES index.
 * @param {string} domain - domain on which to update.
 * @param {string} index - index on which to update.
 * @param {string} id - id of document to update.
 * @param {Object} doc - an object containing the new fields and properties that constitute the update.
 * @returns {HttpResponse} response of the update reqeuest.
 */
export const update = async (domain, index, id, doc, options = {}) => {
	const path = `${index}/_update/${encodeURIComponent(id)}`;
	const payload = { doc };
	const request = buildRequest(domain, path, 'POST', { payload });
	const { body: response, code } = await makeRequest(request, options);
	if (code != 200) {
		throw Error(
			`Update failed at ${domain}/${index} for document with ID: ${id}. 
			Response:\n${stringify(response)}`
		);
	}
	return response;
};

const generateBulkUpdatePayload = index => _.pipe([
	_.flatMapWith(doc =>
		[
			{ update: { "_id": doc.id, "_index": index } },
			{ doc: doc.data }
		]
	),
	_.reduceWith((acc, curr) => `${acc}\n${JSON.stringify(curr)}`, ''),
	json => `${json}\n`
])

/**
 * @function bulkUpdate
 * @description updates multiple documents on an ES index in one request.
 * @param {string} domain - domain on which to update.
 * @param {string} index - index on which to update.
 * @param {Object[]} documents - list of documents, where each object has an id 
 * key and a data key. The data key is the partial document used for updating.
 * @returns {HttpResponse} response of the update reqeuest.
 */
export const bulkUpdate = async (domain, index, documents, options = {}) => {
	const path = `${index}/_bulk`
	const generateForIndex = generateBulkUpdatePayload(index)
	const payload = generateForIndex(documents)
	const request = buildRequest(domain, path, 'POST', { payload, contentType: 'application/x-ndjson' });
	const { body: response, code } = await makeRequest(request, options);
	if (code != 200) {
		throw new Error(`Bulk update failed with response\n${stringify(response)}`)
	}
	return response;
}
