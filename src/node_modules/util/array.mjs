import { isNotNil } from '@svizzle/utils';
import * as cliProgress from 'cli-progress';
import * as _ from 'lamb';

const _batch = (arr, batchSize) => {
	return arr.map((val, i) => {
		if (i % batchSize === 0) {
			return arr.slice(i, i + batchSize);
		}
		return null;
	});
};

export const batch = _.pipe([_batch, _.filterWith(isNotNil)]);

export async function batchIterate(iterable, func, { concat=true }={}) {
	const bar = new cliProgress.Bar(null, cliProgress.Presets.rect);
	bar.start(iterable.length, 0);
	const batches = batch(iterable, 100);
	let results = [];
	for (const batch_ of batches) {
		// eslint-disable-next-line no-await-in-loop
		const result = await func(batch_);
		results = concat ? [...results, ...result] : [...results, result];
		bar.increment(batch_.length);
	}

	bar.stop();
	return results;
}
