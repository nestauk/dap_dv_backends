import * as _ from 'lamb';

import { arxliveCopy } from 'conf/config.mjs';
import { dbr } from 'dbpedia/util.mjs';
import { scroll, clearScroll } from 'es/search.mjs';
import { saveObj } from '@svizzle/file';

// titles are the Wiki pages with whitepace replaced with underscores, so
// World War 1 => World_War_1
// We use this terminology to stay consistent with Wikimedia's API, where the
// this parameter is also named title.
// https://api.wikimedia.org/wiki/API_reference/Core/Pages/Get_page
export const getEntities = async(
	index,
	domain=arxliveCopy,
	{ asTitle=true } = {}
) => {

	const scroller = scroll(domain, index, { size: 10000, });
	const uriCounts = {};
	for await (let page of scroller) {
		_.forEach(page.hits.hits, doc => {
			_.forEach(doc._source.dbpedia_entities, ({ URI }) => {
				const key = asTitle
					? URI.replace(dbr, '')
					: URI;
				uriCounts[key] = uriCounts[key] ? uriCounts[key] + 1 : 1;
			});
		});
	}

	clearScroll(domain);

	const entities = _.keys(uriCounts);
	return entities;
};

export const getAllConfidenceLevels = async(
	index,
	domain=arxliveCopy
) => {
	const scroller = scroll(domain, index, { size: 10000, });
	const confidenceCounts = {};
	for await (let page of scroller) {
		_.forEach(page.hits.hits, doc => {
			_.forEach(doc._source.dbpedia_entities, ({ URI, confidence }) => {
				confidenceCounts[URI] = URI in confidenceCounts
					? [ ...confidenceCounts[URI], confidence ]
					: [ confidence ];
			});
		});
	}

	clearScroll(domain);
	return confidenceCounts;
};
